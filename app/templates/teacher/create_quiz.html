<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/create_quiz.css') }}" />
  </head>
  <body>
    <div class="left">
      
      {% include 'partials/teacher_sidebar.html' %}

    </div>
    <div class="right">
      <div class="header">
        <div class="header-title">
          <span style="font-size: 1.5rem; font-weight: 700; color: #2d3a2d"
            >Quizzes</span
          >
          <span style="font-size: 1rem; color: grey"
            >Welcome back! Here's what's happening with your quizzes
            today.</span
          >
        </div>
      </div>
      <div class="section" style="width: 100%;">
        <div style="display: flex;flex-direction: row;gap: 20px;">
          <div class="quiz-details-card" style="width: 70%;">
            <div class="quiz-details-title">Quiz Details</div>
            <form>
              <div class="quiz-details-form-row">
                <div class="quiz-details-form-col">
                  <label for="quiz-title" class="quiz-details-label">Quiz Title</label>
                  <input type="text" id="quiz-title" name="quiz-title" placeholder="Enter quiz title" class="quiz-details-input" value="{{ quiz.title if edit_mode and quiz else '' }}" />
                </div>
                <div class="quiz-details-form-col">
                  <label for="subject" class="quiz-details-label">Subject</label>
                  <select id="subject" name="subject" class="quiz-details-select">
                    <option>Select subject</option>
                    <option value="Agriculture" {% if edit_mode and quiz and quiz.subject and quiz.subject.name == 'Agriculture' %}selected{% endif %}>Agriculture</option>
                    <option value="Biology" {% if edit_mode and quiz and quiz.subject and quiz.subject.name == 'Biology' %}selected{% endif %}>Biology</option>
                    <option value="Machinery" {% if edit_mode and quiz and quiz.subject and quiz.subject.name == 'Machinery' %}selected{% endif %}>Machinery</option>
                  </select>
                </div>
              </div>
              <div class="quiz-details-form-row">
                <div class="quiz-details-form-col">
                  <label for="time-limit" class="quiz-details-label">Time Limit (minutes)</label>
                  <input type="number" id="time-limit" name="time-limit" value="{{ quiz.time_limit if edit_mode and quiz else 30 }}" class="quiz-details-input" />
                </div>
                <div class="quiz-details-form-col">
                  <label for="difficulty" class="quiz-details-label">Difficulty Level</label>
                  <select id="difficulty" name="difficulty" class="quiz-details-select">
                    <option value="Beginner" {% if edit_mode and quiz and quiz.difficulty == 'Beginner' %}selected{% endif %}>Beginner</option>
                    <option value="Intermediate" {% if edit_mode and quiz and quiz.difficulty == 'Intermediate' %}selected{% endif %}>Intermediate</option>
                    <option value="Advanced" {% if edit_mode and quiz and quiz.difficulty == 'Advanced' %}selected{% endif %}>Advanced</option>
                  </select>
                </div>
              </div>
              <div class="quiz-details-form-col">
                <label for="description" class="quiz-details-label">Description</label>
                <textarea id="description" name="description" placeholder="Brief description of the quiz" class="quiz-details-textarea">{{ quiz.description if edit_mode and quiz else '' }}</textarea>
              </div>
            </form>
          </div>
          <div class="quiz-preview-card" style="width: 30%; background: #fff; border-radius: 12px; padding: 18px; border: 1px solid #e6e6e6; box-shadow: 0 8px 20px rgba(37,99,235,0.06);">
            <h3 style="margin: 0 0 12px 0; font-size: 1.1rem;">Quiz Preview</h3>
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">Total Questions: <span id="preview-total-questions" style="float: right; font-weight: 700; color: #111827;">1</span></div>
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">Time Limit: <span id="preview-time-limit" style="float: right; font-weight: 700; color: #111827;">30 min</span></div>
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">Points: <span id="preview-points" style="float: right; font-weight: 700; color: #111827;">10</span></div>
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">Difficulty: <span id="preview-difficulty" style="float: right; font-weight: 700; color: #111827;">Beginner</span></div>
            <hr style="margin: 12px 0; border: none; border-top: 1px solid #f1f1f1;" />
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">Multiple Choice: <span id="preview-mc" style="float: right; font-weight: 700; color: #111827;">1</span></div>
            <div style="color: #6b7280; font-size: 0.95rem; padding: 8px 0;">True or False: <span id="preview-tf" style="float: right; font-weight: 700; color: #111827;">0</span></div>
          </div>
        </div>
            <div class="questions-card">
          <div style="display: flex; justify-content: space-between; align-items: center;margin-bottom: 20px;">
            <h2>Questions</h2>
            <button type="button" id="add-question-btn" class="add-question-btn">+ Add Question</button>
          </div>
          <div id="questions-container">
            {% if edit_mode and quiz and quiz.questions %}
              {% for q in quiz.questions %}
                <div class="question-box" data-index="{{ loop.index }}">
                  <div class="question-header">
                    <div class="question-title">Question {{ loop.index }}</div>
                    <div class="question-actions">
                      <select class="question-select">
                        <option value="mc" {% if q.type == 'mc' %}selected{% endif %}>Multiple Choice</option>
                        <option value="tf" {% if q.type == 'tf' %}selected{% endif %}>True/False</option>
                      </select>
                      <button type="button" class="question-delete" style="background-color: #e53935; color: #fff; border: none; padding: 6px 14px; border-radius: 4px;font-size: 1rem;">Delete</button>
                    </div>
                  </div>
                  <div class="question-form-col" style="margin-bottom: 12px;">
                    <label class="question-label">Question Text</label>
                    <textarea placeholder="Enter your question here" class="question-textarea">{{ q.text }}</textarea>
                  </div>
                  <div class="question-form-row mc-row" {% if q.type != 'mc' %}style="display:none;"{% endif %}>
                    <div class="question-form-col">
                      <label class="question-label">Option A</label>
                      <input type="text" placeholder="Enter option A" class="question-input" value="{{ q.options[0].text if q.type == 'mc' and q.options|length > 0 else '' }}" />
                    </div>
                    <div class="question-form-col">
                      <label class="question-label">Option B</label>
                      <input type="text" placeholder="Enter option B" class="question-input" value="{{ q.options[1].text if q.type == 'mc' and q.options|length > 1 else '' }}" />
                    </div>
                  </div>
                  <div class="question-form-row mc-row" {% if q.type != 'mc' %}style="display:none;"{% endif %}>
                    <div class="question-form-col">
                      <label class="question-label">Option C</label>
                      <input type="text" placeholder="Enter option C" class="question-input" value="{{ q.options[2].text if q.type == 'mc' and q.options|length > 2 else '' }}" />
                    </div>
                    <div class="question-form-col">
                      <label class="question-label">Option D</label>
                      <input type="text" placeholder="Enter option D" class="question-input" value="{{ q.options[3].text if q.type == 'mc' and q.options|length > 3 else '' }}" />
                    </div>
                  </div>
                  <div class="question-form-col answer-row">
                    <label class="question-label">Correct Answer</label>
                    <select class="question-select-answer">
                      {% if q.type == 'mc' %}
                        <option value="A" {% if q.correct_answer == 'A' %}selected{% endif %}>Option A</option>
                        <option value="B" {% if q.correct_answer == 'B' %}selected{% endif %}>Option B</option>
                        <option value="C" {% if q.correct_answer == 'C' %}selected{% endif %}>Option C</option>
                        <option value="D" {% if q.correct_answer == 'D' %}selected{% endif %}>Option D</option>
                      {% else %}
                        <option value="True" {% if q.correct_answer == 'True' %}selected{% endif %}>True</option>
                        <option value="False" {% if q.correct_answer == 'False' %}selected{% endif %}>False</option>
                      {% endif %}
                    </select>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="question-box" data-index="1">
                <div class="question-header">
                  <div class="question-title">Question 1</div>
                  <div class="question-actions">
                    <select class="question-select">
                      <option value="mc">Multiple Choice</option>
                      <option value="tf">True/False</option>
                    </select>
                    <button type="button" class="question-delete" style="background-color: #e53935; color: #fff; border: none; padding: 6px 14px; border-radius: 4px;font-size: 1rem;">Delete</button>
                  </div>
                </div>
                <div class="question-form-col" style="margin-bottom: 12px;">
                  <label class="question-label">Question Text</label>
                  <textarea placeholder="Enter your question here" class="question-textarea"></textarea>
                </div>
                <div class="question-form-row mc-row">
                  <div class="question-form-col">
                    <label class="question-label">Option A</label>
                    <input type="text" placeholder="Enter option A" class="question-input" />
                  </div>
                  <div class="question-form-col">
                    <label class="question-label">Option B</label>
                    <input type="text" placeholder="Enter option B" class="question-input" />
                  </div>
                </div>
                <div class="question-form-row mc-row">
                  <div class="question-form-col">
                    <label class="question-label">Option C</label>
                    <input type="text" placeholder="Enter option C" class="question-input" />
                  </div>
                  <div class="question-form-col">
                    <label class="question-label">Option D</label>
                    <input type="text" placeholder="Enter option D" class="question-input" />
                  </div>
                </div>
                <div class="question-form-col answer-row">
                  <label class="question-label">Correct Answer</label>
                  <select class="question-select-answer">
                    <option value="A">Option A</option>
                    <option value="B">Option B</option>
                    <option value="C">Option C</option>
                    <option value="D">Option D</option>
                  </select>
                </div>
              </div>
            {% endif %}
          </div>
          <template id="question-template">
            <div class="question-box" data-index="__IDX__">
              <div class="question-header">
                <div class="question-title">Question __NUM__</div>
                <div class="question-actions">
                  <select class="question-select">
                    <option value="mc">Multiple Choice</option>
                    <option value="tf">True/False</option>
                  </select>
                  <button type="button" class="question-delete" style="background-color: #e53935; color: #fff; border: none; padding: 6px 14px; border-radius: 4px;font-size: 1rem;">Delete</button>
                </div>
              </div>
              <div class="question-form-col" style="margin-bottom: 12px;">
                <label class="question-label">Question Text</label>
                <textarea placeholder="Enter your question here" class="question-textarea"></textarea>
              </div>
              <div class="question-form-row mc-row">
                <div class="question-form-col">
                  <label class="question-label">Option A</label>
                  <input type="text" placeholder="Enter option A" class="question-input" />
                </div>
                <div class="question-form-col">
                  <label class="question-label">Option B</label>
                  <input type="text" placeholder="Enter option B" class="question-input" />
                </div>
              </div>
              <div class="question-form-row mc-row">
                <div class="question-form-col">
                  <label class="question-label">Option C</label>
                  <input type="text" placeholder="Enter option C" class="question-input" />
                </div>
                <div class="question-form-col">
                  <label class="question-label">Option D</label>
                  <input type="text" placeholder="Enter option D" class="question-input" />
                </div>
              </div>
              <div class="question-form-col answer-row">
                <label class="question-label">Correct Answer</label>
                <select class="question-select-answer">
                  <option value="A">Option A</option>
                  <option value="B">Option B</option>
                  <option value="C">Option C</option>
                  <option value="D">Option D</option>
                </select>
              </div>
            </div>
          </template>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:18px;">
          <button id="save-quiz-btn" class="add-question-btn" style="background:#2563eb;color:#fff;border:none;padding:10px 16px;border-radius:8px;">{% if edit_mode %}Update Quiz{% else %}Save Quiz{% endif %}</button>
          <div id="save-status" style="align-self:center;color:green;font-weight:600;display:none;"></div>
        </div>
        <script>
          (function(){
            const container = document.getElementById('questions-container');
            const addBtn = document.getElementById('add-question-btn');
            const template = document.getElementById('question-template').innerHTML;
            const timeLimitInput = document.getElementById('time-limit');
            const difficultySelect = document.getElementById('difficulty');

            function updatePreview(){
              const boxes = container.querySelectorAll('.question-box');
              const total = boxes.length;
              let mc = 0, tf = 0;
              boxes.forEach(b => {
                const t = b.querySelector('.question-select').value;
                if(t === 'mc') mc++; else if(t === 'tf') tf++;
              });
              document.getElementById('preview-total-questions').textContent = total;
              document.getElementById('preview-mc').textContent = mc;
              document.getElementById('preview-tf').textContent = tf;
              document.getElementById('preview-time-limit').textContent = (timeLimitInput && timeLimitInput.value ? timeLimitInput.value + ' min' : '0 min');
              document.getElementById('preview-difficulty').textContent = (difficultySelect && difficultySelect.value ? difficultySelect.value : '');
              // Points: simple rule: 2 points per question
              document.getElementById('preview-points').textContent = (total * 2);
            }

            function wireQuestion(box){
              const select = box.querySelector('.question-select');
              const deleteBtn = box.querySelector('.question-delete');
              const onTypeChange = (e)=>{
                const val = e.target.value;
                const mcRows = box.querySelectorAll('.mc-row');
                if(val === 'tf'){
                    mcRows.forEach(r => r.style.display = 'none');
                    // replace correct answer with True/False and try to preserve truthy mapping
                    const ans = box.querySelector('.question-select-answer');
                    if(ans){
                      // if current value maps to true/false (e.g., 'True' or 'False'), keep it, else default to 'True'
                      const current = ans.value && ans.value.toString().toLowerCase();
                      ans.innerHTML = '<option value="True">True</option><option value="False">False</option>';
                      if(current === 'true' || current === 'false'){
                        ans.value = current === 'true' ? 'True' : 'False';
                      } else {
                        ans.value = 'True';
                      }
                    }
                  } else {
                    mcRows.forEach(r => r.style.display = 'flex');
                    const ans = box.querySelector('.question-select-answer');
                    if(ans){
                      // attempt to map True/False back to an option if possible; otherwise default to A
                      const current = ans.value && ans.value.toString().toLowerCase();
                      ans.innerHTML = '<option value="A">Option A</option><option value="B">Option B</option><option value="C">Option C</option><option value="D">Option D</option>';
                      if(current === 'true' || current === 'false'){
                        // no mapping available, default to A
                        ans.value = 'A';
                      } else if(['a','b','c','d'].includes(current)){
                        ans.value = current.toUpperCase();
                      } else {
                        ans.value = 'A';
                      }
                    }
                  }
                updatePreview();
              };
              select.addEventListener('change', onTypeChange);
              // initialize based on current value
              onTypeChange({ target: select });
              deleteBtn.addEventListener('click', ()=>{
                box.remove();
                // renumber
                [...container.querySelectorAll('.question-box')].forEach((b,i)=>{
                  b.dataset.index = i+1;
                  const title = b.querySelector('.question-title');
                  if(title) title.textContent = 'Question ' + (i+1);
                });
                updatePreview();
              });
            }

            // wire existing
            container.querySelectorAll('.question-box').forEach(wireQuestion);

            addBtn.addEventListener('click', ()=>{
              const idx = container.querySelectorAll('.question-box').length + 1;
              const html = template.replace(/__IDX__/g, idx).replace(/__NUM__/g, idx);
              const wrapper = document.createElement('div');
              wrapper.innerHTML = html;
              const newBox = wrapper.firstElementChild;
              container.appendChild(newBox);
              wireQuestion(newBox);
              updatePreview();
            });

            // wire time and difficulty to preview
            if(timeLimitInput) timeLimitInput.addEventListener('input', updatePreview);
            if(difficultySelect) difficultySelect.addEventListener('change', updatePreview);

            // initial preview update
            updatePreview();

            // Save quiz logic
            const saveBtn = document.getElementById('save-quiz-btn');
            const statusEl = document.getElementById('save-status');

            function collectQuizPayload(){
              const title = document.getElementById('quiz-title').value.trim();
              const subject = document.getElementById('subject').value;
              const time_limit = parseInt(document.getElementById('time-limit').value) || 0;
              const difficulty = document.getElementById('difficulty').value;
              const description = document.getElementById('description').value;
              const questionBoxes = [...document.querySelectorAll('.question-box')];
              const questions = questionBoxes.map(box => {
                const type = box.querySelector('.question-select').value;
                const text = box.querySelector('.question-textarea').value.trim();
                const correct = box.querySelector('.question-select-answer').value;
                const options = [];
                if(type === 'mc'){
                  const inputs = box.querySelectorAll('.question-input');
                  const keys = ['A','B','C','D'];
                  inputs.forEach((inp,i)=>{
                    options.push({ key: keys[i], text: inp.value });
                  });
                }
                return { type, text, correct, options };
              });

              return { title, subject, time_limit, difficulty, description, questions };
            }

            saveBtn.addEventListener('click', ()=>{
              statusEl.style.display = 'none';
              const payload = collectQuizPayload();
              if(!payload.title){
                statusEl.style.display = 'block';
                statusEl.style.color = 'red';
                statusEl.textContent = 'Please enter a quiz title.';
                return;
              }

              fetch(window.location.pathname, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              }).then(r => r.json().then(b => ({ status: r.status, body: b })))
                .then(({ status, body }) => {
                  if(status >= 200 && status < 300){
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'green';
                    statusEl.textContent = 'Quiz saved successfully (ID: ' + body.quiz_id + ')';
                    // optionally redirect to quizzes list after a short delay
                    setTimeout(()=>{ window.location.href = '/teacher/quizzes'; }, 900);
                  } else {
                    statusEl.style.display = 'block';
                    statusEl.style.color = 'red';
                    statusEl.textContent = (body && body.error) ? body.error : 'Failed to save quiz';
                  }
                }).catch(err => {
                  statusEl.style.display = 'block';
                  statusEl.style.color = 'red';
                  statusEl.textContent = 'Network or server error';
                });
            });
          })();
        </script>
      </div>
    </div>
  </body>
</html>
